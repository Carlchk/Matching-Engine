<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Example Navbar with Tailwind CSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <!-- <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script> -->
    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .bg-myblack {
            --tw-bg-opacity: 1;
            background-color: rgb(22 26 30 / var(--tw-bg-opacity));
        }

        .label-color {
            --tw-text-opacity: 1;
            color: rgb(132 142 156 / var(--tw-text-opacity));
        }

        .buy-color {
            --tw-text-opacity: 1;
            color: rgb(14 203 129 / var(--tw-text-opacity));
        }

        .bg-buy-color {
            --tw-text-opacity: 1;
            background-color: rgb(14 203 129 / var(--tw-text-opacity));
        }

        .sell-color {
            --tw-text-opacity: 1;
            color: rgb(246 70 93 / var(--tw-text-opacity));
        }

        .bg-sell-color {
            --tw-text-opacity: 1;
            background-color: rgb(246 70 93 / var(--tw-text-opacity));
        }

        .parent {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            grid-column-gap: 0px;
            grid-row-gap: 0px;
        }

        .div1 {
            border: 1px solid black;
            grid-area: 1 / 1 / 6 / 2;
        }

        .div2 {
            border: 1px solid black;
            grid-area: 1 / 2 / 4 / 5;
        }

        .div3 {
            border: 1px solid black;
            grid-area: 4 / 2 / 6 / 4;
        }

        .div4 {
            border: 1px solid black;
            grid-area: 4 / 4 / 6 / 6;
        }

        .div5 {
            border: 1px solid black;
            grid-area: 1 / 5 / 4 / 6;
        }
    </style>

</head>

<body class="h-[calc(100vh-48px)] bg-myblack text-white">
    <nav class="h-12">
        <div class="flex items-center justify-between h-full px-4">
            <h1 class="text-white text-2xl">Order Matching Engine</h1>
            <h5 class="text-white text-sm">Carl CHAN Hei Kuen</h5>

        </div>
    </nav>

    <div class="parent p-2 h-full">
        <div class="div1 orderbook-layout p-2">
            <div class="h-full font-medium">
                <div class="text-white font-semibold">
                    Order Book
                </div>
                <div class="flex flex-row justify-between text-sm font-semibold label-color">
                    <div class="min-w-[33%] text-left">Price(USDT)</div>
                    <div class="min-w-[33%] text-right">Amount</div>
                    <div class="min-w-[33%] text-right pr-2">Total</div>
                </div>
                <div id="asks-order-book" class="buy-color text-sm"></div>
                <div id="latest-price" class="py-2 font-semibold">0</div>
                <div id="bids-order-book" class="sell-color text-sm"></div>
            </div>
        </div>
        <div class="div2 p-2">
            <!-- <div id="container" class="w-full h-full"></div> -->

        </div>
        <div class="div3 p-2">
            Open Order
        </div>
        <div class="div4 p-2">
            Order History
        </div>
        <div class="div5 p-2">
            <div class="flex flex-col justify-around text-sm font-semibold label-color">
                <div class="inline-block relative w-64 m-2">
                    <label class="block uppercase tracking-wide label-color text-xs font-bold mb-2"
                        for="grid-last-name">
                        Order Type
                    </label>
                    <div class="relative">
                        <select name="price_type"
                            class="block appearance-none w-full bg-white border border-gray-400 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
                            <option value="limit">Limted Order</option>
                            <option value="market" disabled>Market Order</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="inline-block relative w-64 m-2">
                    <label class="block uppercase tracking-wide label-color text-xs font-bold mb-2"
                        for="grid-last-name">
                        Price
                    </label>
                    <input type="text" name="price" required
                        class="w-full px-3 py-2 text-gray-700 border rounded focus:outline-none" placeholder="0.00" />
                </div>
                <div class="inline-block relative w-64 m-2">
                    <label class="block uppercase tracking-wide label-color text-xs font-bold mb-2"
                        for="grid-last-name">
                        Qty
                    </label>
                    <input type="text" name="quantity" required
                        class="w-full px-3 py-2 text-gray-700 border rounded focus:outline-none" placeholder="0.00" />
                </div>
                <div class="flex flex-row justify-start text-sm font-semibold label-color">
                    <button class="bg-buy-color hover:bg-buy-color text-white font-bold py-2 px-4 m-2 rounded opt sell">
                        BUY
                    </button>
                    <button class="bg-sell-color hover:bg-buy-color text-white font-bold py-2 px-4 m-2 rounded opt buy">
                        SELL
                    </button>
                </div>
            </div>
        </div>
    </div>

    </div>
    <!-- main script -->
    <script>
        // chart = Highcharts.chart('container', {
        //     chart: {
        //         type: 'area',
        //         zoomType: 'xy',
        //     },
        //     title: {
        //         text: 'ETH-BTC Market Depth'
        //     },
        //     xAxis: {
        //         minPadding: 0,
        //         maxPadding: 0,
        //         plotLines: [{
        //             color: '#888',
        //             value: 0.1523,
        //             width: 1,
        //             label: {
        //                 text: 'Actual price',
        //                 rotation: 90
        //             }
        //         }],
        //         title: {
        //             text: 'Price'
        //         }
        //     },
        //     yAxis: [{
        //         lineWidth: 1,
        //         gridLineWidth: 1,
        //         title: null,
        //         tickWidth: 1,
        //         tickLength: 5,
        //         tickPosition: 'inside',
        //         labels: {
        //             align: 'left',
        //             x: 8
        //         }
        //     }, {
        //         opposite: true,
        //         linkedTo: 0,
        //         lineWidth: 1,
        //         gridLineWidth: 0,
        //         title: null,
        //         tickWidth: 1,
        //         tickLength: 5,
        //         tickPosition: 'inside',
        //         labels: {
        //             align: 'right',
        //             x: -8
        //         }
        //     }],
        //     legend: {
        //         enabled: false
        //     },
        //     plotOptions: {
        //         area: {
        //             fillOpacity: 0.2,
        //             lineWidth: 1,
        //             step: 'center'
        //         }
        //     },
        //     tooltip: {
        //         headerFormat: '<span style="font-size=10px;">Price: {point.key}</span><br/>',
        //         valueDecimals: 2
        //     },
        //     series: [{
        //         name: 'Bids',
        //         data: [],
        //         color: '#03a7a8'
        //     }, {
        //         name: 'Asks',
        //         data: [],
        //         color: '#fc5857'
        //     }]
        // });

        // Global Variables

        let dataBids = []
        let dataAsks = []

        // Helper Function
        function formatTime(t) {
            var d = new Date(t);
            return d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
        }

        function convertToNumbers(arr) {
            return arr.map(subArr => subArr.map(elem => parseFloat(elem)));
        }

        $(".opt").on("click", function () {
            var type = $(this).hasClass("sell") ? "ask" : "bid";
            var price_type = $("select[name='price_type']").val();
            $.ajax({
                url: "/api/new_order",
                type: "post",
                dataType: "json",
                contentType: "application/json",
                data: function () {
                    var data = {
                        price_type: price_type,
                        order_type: type,
                    };

                    data.price = $("input[name='price']").val();
                    data.quantity = $("input[name='quantity']").val();

                    console.log(data);
                    return JSON.stringify(data)
                }(),
                success: function (d) {
                    if (d.ok) {
                        console.log("下单" + d.ok + " askLen:" + d.data.ask_len + " bidLen:" + d.data.bid_len);
                    } else {
                        console.log(d.error);
                    }
                }
            });
        })



        // Re-render: Order Book
        function orderbookRender(data, type) {
            if (type === "ask") {
                $('#asks-order-book').empty();
            } else {
                $('#bids-order-book').empty();
            }

            // generate HTML for each row
            const rows = data.map(([price, amount]) => `
                <div class="flex flex-row justify-between">
                    <div class="min-w-[33%] text-left">${price}</div>
                    <div class="min-w-[33%] text-right font-normal">${amount}</div>
                    <div class="min-w-[33%] text-right font-normal pr-2">\$${price * amount}</div>
                </div>
            `);

            // join rows and inject them to the DOM
            const html = rows.join('');
            if (type === "ask") {
                $('#asks-order-book').append(html);
            } else {
                $('#bids-order-book').append(html);
            }
        }

        // Websocket handler
        var socket = function () {
            if (window["WebSocket"]) {

                var protocol = window.location.protocol == "https:" ? "wss:" : "ws:";
                conn = new WebSocket(protocol + "//" + document.location.host + "/ws");

                conn.onclose = function (evt) {
                    alert("<b>WebSocket Connection closed</b>");
                    setTimeout(function () {
                        socket();
                    }, 5e3);
                };

                conn.onmessage = function (evt) {
                    var messages = evt.data.split('\n');

                    for (var i = 0; i < messages.length; i++) {

                        var data = JSON.parse(messages[i]);

                        if (data.tag == "depth") {
                            var info = data.data;
                            console.log(info.ask)
                            orderbookRender(info.ask.reverse(), "ask");
                            orderbookRender(info.bid, "bid");
                            // dataBids = convertToNumbers(info.bid)
                            // dataAsks = convertToNumbers(info.ask.reverse())
                            // chart.series[0].update({
                            //     data: dataBids
                            // }, false)

                            // chart.series[1].update({
                            //     data: dataAsks
                            // })

                        } else if (data.tag == "latest_price") {
                            $("#latest-price").html(data.data.latest_price);
                            chart.update({
                                xAxis: {
                                    plotLines: [{
                                        color: '#888',
                                        value: data.data.latest_price,
                                        width: 1,
                                        label: {
                                            text: 'Actual price',
                                            rotation: 90
                                        }
                                    }]
                                }
                            })
                        }
                    }
                };
            }
        }
        socket();

    </script>
</body>

</html>